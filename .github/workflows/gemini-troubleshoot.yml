name: "üîç Gemini Error Analyst"

on:
  workflow_run:
    workflows: ["Terraform AKS Cluster Deploy"]
    types: [completed]

jobs:
  analyze-failure:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Gemini cannot "reach out" to get logs via a prompt alone. 
      # You must download the logs first or pass them as input.
      - name: "ü§ñ Gemini Analyze Failure"
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          # Use the 'args' field or positional arguments depending on the action version
          args: |
            "The 'Terraform AKS Cluster Deploy' workflow failed. 
            Identify the root cause and propose a fix for the following error:
            ${{ github.event.workflow_run.conclusion }}"